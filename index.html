<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yumana Unified Chat</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      /* Login Styles */
      #loginPage {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 350px;
        text-align: center;
      }
      .input-group {
        margin-bottom: 15px;
        text-align: left;
      }
      label {
        display: block;
        font-size: 14px;
        margin-bottom: 5px;
        color: #555;
      }
      input[type="email"],
      input[type="password"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
        outline: none;
      }
      input:focus {
        border-color: #0084ff;
      }
      .btn-login {
        background: #0084ff;
        color: white;
        border: none;
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
        transition: 0.3s;
      }
      .btn-login:hover {
        background: #0073e6;
      }
      .btn-login:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .error-msg {
        color: #dc3545;
        font-size: 12px;
        margin-top: 10px;
        display: none;
      }

      /* Chat Styles (Hidden by default) */
      #chatPage {
        display: none;
        width: 100%;
        max-width: 900px;
        height: 90vh;
        background: white;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      header {
        background: #0084ff;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: #e5ddd5;
      }

      /* Message Bubbles */
      .msg {
        padding: 8px 12px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        font-size: 14px;
        position: relative;
      }
      .msg.system {
        align-self: center;
        background: #fff3cd;
        color: #856404;
        font-size: 12px;
        border-radius: 5px;
        padding: 4px 10px;
      }
      .msg.other {
        align-self: flex-start;
        background: white;
        border-bottom-left-radius: 2px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      }
      .msg.me {
        align-self: flex-end;
        background: #dcf8c6;
        border-bottom-right-radius: 2px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      }
      .sender-name {
        font-weight: bold;
        font-size: 11px;
        display: block;
        margin-bottom: 2px;
        color: #075e54;
      }

      .input-area {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
        background: #f0f0f0;
      }
      #messageInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 25px;
        outline: none;
      }
      .send-btn {
        background: #075e54;
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
    </style>
  </head>
  <body>
    <div id="loginPage">
      <h2 style="color: #0084ff; margin-top: 0">Chat Iseng</h2>
      <p style="color: #666; font-size: 14px; margin-bottom: 25px">
        Masukkan kredensial akun Anda
      </p>

      <div class="input-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="contoh@mail.com" />
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="********" />
      </div>
      <button class="btn-login" id="loginBtn" onclick="doLogin()">
        Masuk & Hubungkan
      </button>
      <div id="errorMsg" class="error-msg">
        Gagal masuk. Periksa email dan password Anda.
      </div>
    </div>

    <div id="chatPage">
      <header>
        <div style="display: flex; align-items: center; gap: 10px">
          <div
            style="
              width: 35px;
              height: 35px;
              background: white;
              border-radius: 50%;
              color: #0084ff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
            "
            id="userInitial"
          >
            Y
          </div>
          <span id="displayUsername" style="font-weight: bold">Lobby Chat</span>
        </div>
        <button
          onclick="location.reload()"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 5px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 12px;
          "
        >
          Keluar
        </button>
      </header>
      <div id="log"></div>
      <div class="input-area">
        <input
          type="text"
          id="messageInput"
          placeholder="Ketik pesan di sini..."
          onkeypress="if (event.key === 'Enter') sendMessage();"
        />
        <button class="send-btn" onclick="sendMessage()">âž¤</button>
      </div>
    </div>

    <script>
      let socket;
      let myUsername = "";
      let jwtToken = "";

      // Fungsi Login ke REST API
      async function doLogin() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const loginBtn = document.getElementById("loginBtn");
        const errorMsg = document.getElementById("errorMsg");

        if (!email || !password) {
          errorMsg.innerText = "Email dan password wajib diisi.";
          errorMsg.style.display = "block";
          return;
        }

        loginBtn.innerText = "Menghubungkan...";
        loginBtn.disabled = true;
        errorMsg.style.display = "none";

        try {
          // 1. Validasi via REST API
          const response = await fetch("https://api.yumana.my.id/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const result = await response.json();

          if (response.ok && result.token) {
            jwtToken = result.token;
            myUsername = result.user.username;
            document.getElementById("userInitial").innerText = myUsername
              .charAt(0)
              .toUpperCase();

            // 2. Inisialisasi WebSocket setelah token didapat
            initWebSocket();
          } else {
            throw new Error("Kredensial salah");
          }
        } catch (err) {
          errorMsg.innerText =
            "Login Gagal: Akun tidak ditemukan atau server sibuk.";
          errorMsg.style.display = "block";
          loginBtn.innerText = "Masuk & Hubungkan";
          loginBtn.disabled = false;
        }
      }

      // Fungsi Inisialisasi WebSocket
      function initWebSocket() {
        socket = new WebSocket("ws://127.0.0.1:8080");

        socket.onopen = () => {
          // 3. Kirim pesan Autentikasi ke server Rust
          socket.send(
            JSON.stringify({
              type: "authenticate",
              token: jwtToken,
            }),
          );
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === "authenticated") {
            // Transisi UI dari Login ke Chat
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("chatPage").style.display = "flex";
            document.getElementById("displayUsername").innerText =
              `${myUsername}`;
            addLog("System", `Tersambung sebagai ${myUsername}`, "system");
          } else if (data.type === "chat_message") {
            const isMe = data.from === myUsername;
            addLog(data.from, data.content, isMe ? "me" : "other");
          } else if (data.type === "error") {
            alert("Gagal Autentikasi WebSocket: " + data.message);
            location.reload();
          }
        };

        socket.onclose = () => {
          addLog("System", "Koneksi ke server terputus.", "system");
          setTimeout(() => {
            location.reload();
          }, 2000);
        };
      }

      // Fungsi Kirim Pesan
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content || !socket) return;

        socket.send(
          JSON.stringify({
            type: "send_message",
            content: content,
          }),
        );
        input.value = "";
      }

      // Helper untuk Log Chat
      function addLog(sender, text, type) {
        const log = document.getElementById("log");
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${type}`;

        if (type !== "system") {
          const nameLabel =
            type === "other"
              ? `<span class="sender-name">${sender}</span>`
              : "";
          msgDiv.innerHTML = `${nameLabel}${text}`;
        } else {
          msgDiv.innerText = text;
        }

        log.appendChild(msgDiv);
        log.scrollTop = log.scrollHeight;
      }
    </script>
  </body>
</html>
